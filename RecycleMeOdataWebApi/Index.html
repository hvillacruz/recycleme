<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="http://recyclemeapi.azurewebsites.net/Scripts/jquery-1.6.4.min.js"></script>
    <script src="http://recyclemeapi.azurewebsites.net/Scripts/jquery.signalR-2.1.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://recyclemeapi.azurewebsites.net/signalr/hubs"></script>

    <script>
        


        var ChatHubWrapper = function () {
            var self = this;
            var chat = null;
            var isStarted = false;
            var onMessageCallback = function () { };

            self.start = function () {
                chat = $.connection.chatHub;
                var connection = $.connection.hub;
                connection.url = "http://recyclemeapi.azurewebsites.net/signalr";
                //connection.url = "http://localhost:49892/signalr";

                chat.client.onMessage = onMessageCallback;
                chat.client.work = function (res) {
                    alert(res);
                }
                return $.connection.hub.start()
                        .done(function () {
                            isStarted = true;
                        });

            };

            self.stop = function () {
                isStarted = false;
                chat = null;
                return $.connection.hub.stop();
            };

            self.sendMessage = function (message) {
                if (isStarted)
                    chat.server.sendMessage(message);

            };

            self.sendMessageNoAuth = function (message) {
                if (isStarted)
                    chat.server.sendMessageNoAuth(message);

            };

            self.onMessage = function (callback) {
                onMessageCallback = callback;
                if (isStarted)
                    chat.client.onMessage = onMessageCallback;
            };


            self.useBearerToken = function (token) {
                var wasStarted = isStarted;

                
                if (isStarted)
                // restart, so that connection is assigned to correct group
                    self.stop();
                setTokenCookie(token);


                if (wasStarted) {
                     self.start();

                    setTimeout(function () {
                        self.sendMessageNoAuth("Manuel-N");
                        self.sendMessage("henry");
                    }, 5000);
                }


            };

            function setTokenCookie(token) {
                if (token) {
                    document.cookie = "BearerToken=" + token + "; path=/";
                   
                }
            }

            self.clearAuthentication = function () {
                document.cookie = "BearerToken=; path=/; expires=" + new Date(0).toUTCString();
            }

        };

        var chatHub = new ChatHubWrapper();
        // clear token cookie when page reloads
        // chatHub.clearAuthentication();

        $(document).ready(function () {
            //chatHub.onMessage(appendMessage);
            chatHub.start().done(function () {
                //toastr.success("Connected to the hub");
                //chatHub.sendMessageNoAuth("shit");
                signIn("signalr", "Password1");
            });

            //signIn("signalr", "Password1");

        });

      
        function signIn(userName, password) {
            //$.support.cors = true;
            //return AjaxNinja.Invoke("http://localhost:26264/token", "GET", {}, function (result) {

            //    AjaxNinja.Invoke("http://localhost:26264/api/Orders", "GET", {}, function (result) {

            //        alert('success');

            //    });

            //});


            return $.post("http://recyclemeapi.azurewebsites.net/token", { grant_type: "password", username: userName, password: password })
                    .done(function (data) {
                        //setTimeout(function () {
                        //    var post = $.connection.postHub;
                        //    //$.connection.hub.url = "http://recyclemesignalr.azurewebsites.net/signalr";
                        //    post.client.addMessage = function (msg) {
                        //        alert(msg);
                        //    }

                        //    $.connection.hub.start().done(function () {
                        //        console.log('Now connected, connection ID=' + $.connection.hub.id);
                        //        post.server.hello("Henry");
                        //    }).fail(function (error) {
                        //        console.log('Could not Connect!');
                        //    });
                        //},5000);

                        if (data && data.access_token) {
                            chatHub.useBearerToken(data.access_token);
                            bearerToken = data.access_token;
                         
                        }
                    })
                    .fail(function (xhr) {
                        if (xhr.status == 400) {
                            //toastr.error("Invalid user name or password");
                        } else {
                            //toastr.error("Unexpected error while signing in");
                        }
                    });
        }

        //signIn("signalr", "Password1");
    </script>

</head>
<body>

</body>
</html>
